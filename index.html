<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Padel — JEBMACS vs GPC (cloud sync)</title>
  <style>
    :root{
      --bg-top:#dff7e8; --bg-bottom:#eefef2;
      --card:#fff; --gpc-green:#0f8b46; --gpc-dark:#054a2a;
      --muted:#374151; --danger:#dc2626;
    }
    html,body{height:100%;margin:0}
    body{
      margin:0;padding:20px;
      background:linear-gradient(180deg,var(--bg-top) 0%,var(--bg-bottom) 100%);
      color:#022815;font-family:Inter,system-ui,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
      box-sizing:border-box;
    }
    *,*::before,*::after{box-sizing:inherit}
    .container{max-width:1100px;margin:0 auto}
    .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 10px 28px rgba(6,40,20,0.08);margin-bottom:14px}
    .small{font-size:0.86rem;color:var(--muted)}
    .teams-inline{display:flex;gap:18px;align-items:center}
    .team{display:flex;gap:10px;align-items:center}
    .team img{width:64px;height:64px;object-fit:contain;border-radius:8px;border:2px solid rgba(5,74,42,0.06);background:#fff;padding:6px}

    /* Calendar controls - responsive and non-overflowing */
    .calendar-wrap{margin-top:12px}
    .cal-controls{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
      flex-wrap:wrap;
      align-content:flex-start;
    }
    .cal-left{
      display:flex;
      gap:8px;
      align-items:center;
      flex:1 1 0;
      min-width:0; /* allow shrinking on small screens */
      flex-wrap:wrap;
    }
    .cal-month{
      flex:1 1 0;
      text-align:center;
      font-weight:800;
      min-width:0; /* crucial so it doesn't force width */
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .cal-right{
      flex:0 1 220px;
      text-align:right;
      min-width:0;
    }

    /* On small screens stack controls vertically so nothing overflows */
    @media (max-width:640px){
      .cal-controls{flex-direction:column;align-items:stretch}
      .cal-left{order:1;justify-content:flex-start}
      .cal-month{order:2;text-align:left}
      .cal-right{order:3;text-align:left;margin-top:6px}
    }

    .month-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .day{background:#fff;border-radius:8px;padding:8px;min-height:64px;box-shadow:0 2px 8px rgba(2,6,23,0.04);position:relative}
    .day.dim{opacity:0.62}
    .date-num{font-weight:700;margin-bottom:6px}
    .pill{display:block;padding:6px 8px;border-radius:8px;margin-bottom:6px;cursor:pointer;font-size:0.88rem;font-weight:700}
    .pill.unplayed{background:linear-gradient(90deg,rgba(15,139,70,0.12),rgba(230,182,0,0.02));border:1px solid rgba(5,74,42,0.08);color:var(--gpc-dark)}
    .pill.played{background:#f9fafb;border:1px solid #e6eef0;color:#475569;opacity:0.9}
    .pill.event{background:linear-gradient(90deg,rgba(14,90,45,0.12),rgba(242,194,0,0.05));border:1px solid rgba(10,107,60,0.06)}

    /* Form basics and constraints to prevent overflow */
    input[type="text"], input[type="date"], input[type="number"], textarea, select{
      width:100%;max-width:100%;padding:9px;border-radius:8px;border:1px solid rgba(5,74,42,0.06);background:#fff;font-size:0.95rem;
      box-sizing:border-box;
    }
    input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
    input[type=number]{-moz-appearance:textfield}

    /* Score table + compact inputs */
    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:0.95rem}
    th,td{padding:8px 10px;border-bottom:1px solid rgba(5,74,42,0.06);vertical-align:middle;text-align:left}
    .score-table{border-collapse:collapse;width:100%;max-width:720px;margin-top:6px}
    .score-table th,.score-table td{border:1px solid rgba(5,74,42,0.06);padding:6px;text-align:center}
    input.score-input{
      width:34px !important;
      min-width:30px;
      max-width:46px;
      padding:6px !important;
      box-sizing:border-box;
      text-align:center;
      font-weight:700;
      border-radius:6px;
      vertical-align:middle;
    }
    @media (max-width:820px){
      input.score-input{ width:40px !important; min-width:36px; max-width:48px; }
    }
    .score-table td{white-space:nowrap}

    .sets-won-badge{display:inline-flex;align-items:center;justify-content:center;padding:6px 8px;border-radius:8px;background:rgba(15,139,70,0.12);border:1px solid rgba(15,139,70,0.28);color:var(--gpc-dark);font-weight:800;min-width:28px;height:32px;line-height:1;box-sizing:border-box}
    .winner-badge{font-weight:900;color:var(--gpc-dark);background:linear-gradient(90deg,rgba(15,139,70,0.12),rgba(230,182,0,0.06));padding:6px 10px;border-radius:10px;display:inline-block}

    /* responsive history */
    .table-responsive{overflow-x:auto;-webkit-overflow-scrolling:touch}
    .actions{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
    button{background:var(--gpc-green);color:white;padding:9px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    button.secondary{background:transparent;color:var(--gpc-dark);border:1px solid rgba(5,74,42,0.12);padding:8px 10px}
    button.danger{background:var(--danger)}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <!-- Firebase (same modular block) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signInAnonymously, signOut as fbSignOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, doc, setDoc, addDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDNNJkdSRnHJmRhemsWahx496Nw9WdhtxY",
      authDomain: "gpc-trax.firebaseapp.com",
      projectId: "gpc-trax",
      storageBucket: "gpc-trax.firebasestorage.app",
      messagingSenderId: "729751946370",
      appId: "1:729751946370:web:6d4f0ecda5a53da325a09b",
      measurementId: "G-3NT1ER9X7X"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window._firebase = { app, auth, db };
    window.seasons = window.seasons || [];
    window.matches = window.matches || [];
    window.events = window.events || [];

    let unsubscribeSeasons=null, unsubscribeMatches=null, unsubscribeEvents=null;
    function startRealtimeListeners(){
      if (unsubscribeSeasons || unsubscribeMatches || unsubscribeEvents) return;
      const seasonsQ = query(collection(db,'seasons'),orderBy('createdAt','desc'));
      unsubscribeSeasons = onSnapshot(seasonsQ,snap=>{ window.seasons=snap.docs.map(d=>({id:d.id,...d.data()})); if(typeof populateSeasonsUI==='function') populateSeasonsUI(); if(typeof renderAll==='function') renderAll(); });
      const matchesQ = query(collection(db,'matches'),orderBy('date','desc'));
      unsubscribeMatches = onSnapshot(matchesQ,snap=>{ window.matches=snap.docs.map(d=>({id:d.id,...d.data()})); if(typeof renderAll==='function') renderAll(); });
      const eventsQ = query(collection(db,'events'),orderBy('date','asc'));
      unsubscribeEvents = onSnapshot(eventsQ,snap=>{ window.events=snap.docs.map(d=>({id:d.id,...d.data()})); if(typeof renderUpcomingList==='function') renderUpcomingList(); if(typeof renderAll==='function') renderAll(); });
    }
    function stopRealtimeListeners(){ if(unsubscribeSeasons){unsubscribeSeasons();unsubscribeSeasons=null;} if(unsubscribeMatches){unsubscribeMatches();unsubscribeMatches=null;} if(unsubscribeEvents){unsubscribeEvents();unsubscribeEvents=null;} }

    const googleProvider = new GoogleAuthProvider();
    window.dbSignInWithGoogle = async()=>{ const res=await signInWithPopup(auth,googleProvider); return res.user; };
    window.dbSignInAnonymously = async()=>{ const res=await signInAnonymously(auth); return res.user; };
    window.dbSignOut = async()=>{ try{ await fbSignOut(auth);}catch(e){console.warn(e);} };

    // Robust helpers (strip undefined id etc.)
    window.dbSaveMatch = async function(match){
      if(!match) throw new Error('match required');
      const data={...match};
      if(!data.createdAt) data.createdAt=new Date().toISOString();
      Object.keys(data).forEach(k=>{ if(data[k]===undefined) delete data[k]; });
      if(data.id){ const id=data.id; delete data.id; await setDoc(doc(db,'matches',id),data); return id; }
      if('id' in data) delete data.id;
      const r=await addDoc(collection(db,'matches'),data); return r.id;
    };
    window.dbDeleteMatch = async id=>{ if(!id) throw new Error('id required'); await deleteDoc(doc(db,'matches',id)); };

    window.dbSaveEvent = async function(evt){
      if(!evt) throw new Error('event required');
      const data={...evt}; if(!data.createdAt) data.createdAt=new Date().toISOString();
      Object.keys(data).forEach(k=>{ if(data[k]===undefined) delete data[k]; });
      if(data.id){ const id=data.id; delete data.id; await setDoc(doc(db,'events',id),data); return id; }
      if('id' in data) delete data.id;
      const r=await addDoc(collection(db,'events'),data); return r.id;
    };
    window.dbDeleteEvent = async id=>{ if(!id) throw new Error('id required'); await deleteDoc(doc(db,'events',id)); };

    window.dbSaveSeason = async function(season){
      if(!season) throw new Error('season required');
      const data={...season}; if(!data.createdAt) data.createdAt=new Date().toISOString();
      Object.keys(data).forEach(k=>{ if(data[k]===undefined) delete data[k]; });
      if(data.id){ const id=data.id; delete data.id; await setDoc(doc(db,'seasons',id),data); return id; }
      if('id' in data) delete data.id;
      const r=await addDoc(collection(db,'seasons'),data); return r.id;
    };

    window.dbMigrateLocalToFirestore = async function(){
      if(!confirm('Upload local matches, seasons and events to Firestore?')) return;
      const LS_MATCHES='padel.matches.v4.seasoned', LS_SEASONS='padel.seasons.v1', LS_EVENTS='padel.events.v1';
      const localMatches=JSON.parse(localStorage.getItem(LS_MATCHES)||'[]');
      const localSeasons=JSON.parse(localStorage.getItem(LS_SEASONS)||'[]');
      const localEvents=JSON.parse(localStorage.getItem(LS_EVENTS)||'[]');
      try{ for(const s of localSeasons) await window.dbSaveSeason(s); for(const m of localMatches) await window.dbSaveMatch(m); for(const ev of localEvents) await window.dbSaveEvent(ev); alert('Migration complete.'); }
      catch(err){ console.error(err); alert('Migration failed - see console'); }
    };

    window.dbFetchNow = async function(){
      const snaps = {
        seasons: await getDocs(query(collection(db,'seasons'),orderBy('createdAt','desc'))),
        matches: await getDocs(query(collection(db,'matches'),orderBy('date','desc'))),
        events:  await getDocs(query(collection(db,'events'),orderBy('date','asc')))
      };
      window.seasons = snaps.seasons.docs.map(d=>({id:d.id,...d.data()}));
      window.matches = snaps.matches.docs.map(d=>({id:d.id,...d.data()}));
      window.events = snaps.events.docs.map(d=>({id:d.id,...d.data()}));
      if(typeof renderAll==='function') renderAll();
      return {seasons:window.seasons,matches:window.matches,events:window.events};
    };

    onAuthStateChanged(auth,user=>{ startRealtimeListeners(); window.currentUser=user; if(typeof onFirebaseAuthStateChanged==='function') onFirebaseAuthStateChanged(user); });
    console.log('Firebase initialized');
  </script>

  <!-- App UI -->
  <div class="container">
    <header style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px">
      <div class="teams-inline">
        <div class="team"><img src="jebmacs.png" alt="JEBMACS"><div><strong>JEBMACS</strong><div class="small">Janne & Max</div></div></div>
        <div class="team"><img src="gpc.png" alt="GPC"><div><strong>GPC</strong><div class="small">Miiku & Timi</div></div></div>
      </div>

      <div style="margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <label class="small" for="season-select">Season</label>
        <select id="season-select"></select>
        <button id="new-season" class="secondary">New season</button>
        <button id="migrate-local" class="secondary">Migrate local → Cloud</button>
        <button id="auth-btn" class="secondary">Sign in</button>
      </div>
    </header>

    <section class="card">
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <div style="font-weight:800;color:var(--gpc-dark)">Season record</div>
        <div id="season-record" class="small">JEB: 0-0 • GPC: 0-0</div>
        <div style="width:20px"></div>
        <div style="font-weight:800;color:var(--gpc-dark)">All-time</div>
        <div id="alltime-record" class="small">JEB: 0-0 • GPC: 0-0</div>
        <div style="margin-left:auto" class="small">View: <select id="view-filter"><option value="all">All seasons</option><option value="current">Only current season</option></select></div>
      </div>
    </section>

    <section class="card calendar-wrap">
      <div class="cal-controls">
        <div class="cal-left">
          <button id="prev-month" class="secondary">◀</button>
          <div id="month-label" class="cal-month">February 2026</div>
          <button id="next-month" class="secondary">▶</button>
          <button id="today-btn" class="secondary">Today</button>
          <button id="toggle-calendar" class="secondary">Hide calendar</button>
        </div>
        <div class="cal-right small">Click a date to add an upcoming match / event; click an item to edit or record result.</div>
      </div>

      <div id="calendar-body">
        <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:6px">
          <div class="small" style="text-align:center">Mon</div><div class="small" style="text-align:center">Tue</div><div class="small" style="text-align:center">Wed</div>
          <div class="small" style="text-align:center">Thu</div><div class="small" style="text-align:center">Fri</div><div class="small" style="text-align:center">Sat</div><div class="small" style="text-align:center">Sun</div>
        </div>
        <div id="month-grid" class="month-grid"></div>
      </div>
    </section>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Upcoming matches & events</h3>
        <button id="add-upcoming" class="secondary">Add upcoming match / event</button>
      </div>

      <div id="upcoming-form" style="display:none;margin-top:10px">
        <form id="evt-form" class="grid">
          <input type="hidden" id="evt-id" />
          <label>Date <input id="evt-date" type="date" /></label>
          <label>Title <input id="evt-title" type="text" placeholder="e.g. Practice or Friendly match" /></label>
          <label>Notes <input id="evt-notes" type="text" placeholder="Optional" /></label>
          <div class="actions"><button id="save-evt">Save upcoming</button><button id="save-evt-and-open" class="secondary">Save & open Record Match</button><button id="cancel-evt" type="button" class="secondary">Cancel</button></div>
        </form>
      </div>

      <div id="upcoming-list" class="events-list" style="margin-top:12px"></div>
    </section>

    <section class="card">
      <h3>Record Match (sets)</h3>
      <form id="match-form" class="grid" aria-labelledby="match-form">
        <input type="hidden" id="match-id" />
        <label>Date <input id="date" type="date" required /></label>

        <label>Score (games per set)</label>
        <table class="score-table" aria-label="Set scores">
          <thead><tr><th>Teams</th><th>Set 1</th><th>Set 2</th><th>Set 3</th><th>Sets Won</th></tr></thead>
          <tbody>
            <tr>
              <td style="text-align:left"><strong id="label-jeb">JEBMACS</strong></td>
              <td><input class="score-input" id="jeb-s1" type="number" min="0" /></td>
              <td><input class="score-input" id="jeb-s2" type="number" min="0" /></td>
              <td><input class="score-input" id="jeb-s3" type="number" min="0" /></td>
              <td><span id="jeb-sets-won" class="sets-won-badge">0</span></td>
            </tr>
            <tr>
              <td style="text-align:left"><strong id="label-gpc">GPC</strong></td>
              <td><input class="score-input" id="gpc-s1" type="number" min="0" /></td>
              <td><input class="score-input" id="gpc-s2" type="number" min="0" /></td>
              <td><input class="score-input" id="gpc-s3" type="number" min="0" /></td>
              <td><span id="gpc-sets-won" class="sets-won-badge">0</span></td>
            </tr>
          </tbody>
        </table>

        <label>Winner (auto) <input id="winner" type="text" readonly /></label>
        <label>Paid by <select id="paidBy"><option value="">(none)</option><option>Janne</option><option>Max</option><option>Miiku</option><option>Timi</option></select></label>
        <label>Notes <input id="notes" type="text" placeholder="Optional notes" /></label>

        <div class="actions">
          <button type="submit" id="save-btn">Save match</button>
          <button type="button" id="clear-btn" class="secondary">Clear</button>
          <button type="button" id="export-csv" class="secondary">Export CSV</button>
          <div id="stored-count" class="small" style="margin-left:auto"></div>
        </div>
      </form>
    </section>

    <section class="card">
      <h3>Matches (history)</h3>
      <div class="table-responsive">
        <table id="matches-table">
          <thead><tr><th>Date (season)</th><th>Score (sets)</th><th>Winner</th><th>Paid by</th><th>Notes</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- App script (UI wiring + rendering - same logic) -->
  <script>
    const TEAMS={JEB:{id:'JEBMACS',label:'JEBMACS'},GPC:{id:'GPC',label:'GPC'}};
    let currentSeasonId=null;
    function pad(n){return String(n).padStart(2,'0');}
    function isoDateFromParts(y,m,d){return `${y}-${pad(m+1)}-${pad(d)}`;}
    function displayDate(iso){ if(!iso) return ''; const [y,m,d]=iso.split('-'); return `${d}-${m}-${y}`; }

    const seasonSelect=document.getElementById('season-select');
    const viewFilter=document.getElementById('view-filter');

    function populateSeasonsUI(){
      const list = window.seasons||[];
      seasonSelect.innerHTML='';
      list.slice().sort((a,b)=>a.createdAt.localeCompare(b.createdAt)).forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; seasonSelect.appendChild(o); });
      const last=localStorage.getItem('padel.lastSeasonId');
      if(last && list.some(x=>x.id===last)) currentSeasonId=last;
      if(!currentSeasonId && list.length>0) currentSeasonId=list[0].id;
      seasonSelect.value=currentSeasonId;
    }
    seasonSelect.addEventListener('change',e=>{ currentSeasonId=e.target.value; localStorage.setItem('padel.lastSeasonId',currentSeasonId); renderAll(); });

    // Calendar controls
    const monthLabelEl=document.getElementById('month-label');
    let viewYear = new Date().getFullYear(), viewMonth = new Date().getMonth();
    function setMonthLabel(){ monthLabelEl.textContent = new Date(viewYear,viewMonth,1).toLocaleString(undefined,{month:'long',year:'numeric'}); }

    document.getElementById('prev-month').addEventListener('click',()=>{ viewMonth--; if(viewMonth<0){ viewMonth=11; viewYear--; } renderCalendar(); });
    document.getElementById('next-month').addEventListener('click',()=>{ viewMonth++; if(viewMonth>11){ viewMonth=0; viewYear++; } renderCalendar(); });
    document.getElementById('today-btn').addEventListener('click',()=>{ const now=new Date(); viewYear=now.getFullYear(); viewMonth=now.getMonth(); renderCalendar(); });

    const calendarBody = document.getElementById('calendar-body');
    const toggleBtn = document.getElementById('toggle-calendar');
    if(window.innerWidth<=700){ calendarBody.classList.add('hidden'); toggleBtn.textContent='Show calendar'; }
    toggleBtn.addEventListener('click', ()=>{ if(calendarBody.classList.contains('hidden')){ calendarBody.classList.remove('hidden'); toggleBtn.textContent='Hide calendar'; } else { calendarBody.classList.add('hidden'); toggleBtn.textContent='Show calendar'; } });

    function filterMatchesAndEvents(){ const view=viewFilter.value; return { filteredMatches: window.matches || [], filteredEvents: window.events || [] }; }

    function renderCalendar(){
      setMonthLabel();
      const grid=document.getElementById('month-grid'); grid.innerHTML='';
      const first=new Date(viewYear,viewMonth,1);
      const startDay=(first.getDay()+6)%7;
      const daysInMonth=new Date(viewYear,viewMonth+1,0).getDate();
      for(let i=0;i<startDay;i++){ const el=document.createElement('div'); el.className='day'; el.style.background='#fafafa'; grid.appendChild(el); }
      const { filteredMatches, filteredEvents } = filterMatchesAndEvents();
      for(let d=1; d<=daysInMonth; d++){
        const iso=isoDateFromParts(viewYear,viewMonth,d);
        const dayDiv=document.createElement('div'); dayDiv.className='day';
        const dateNum=document.createElement('div'); dateNum.className='date-num'; dateNum.textContent=d; dayDiv.appendChild(dateNum);
        filteredEvents.filter(ev=>ev.date===iso).slice(0,3).forEach(ev=>{ const pill=document.createElement('div'); pill.className='pill event'; pill.textContent=ev.title||'(event)'; pill.title=ev.notes||''; pill.onclick=()=>{}; dayDiv.appendChild(pill); });
        filteredMatches.filter(m=>m.date===iso).slice(0,3).forEach(m=>{ const pill=document.createElement('div'); pill.className='pill '+(m.winner?'played':'unplayed'); pill.textContent = `${m.winner? (m.winner===TEAMS.JEB.id?'JEB*':'GPC*') : 'Match'} ${m.jebSets??''}-${m.gpcSets??''}`; pill.onclick=()=>{}; dayDiv.appendChild(pill); });
        const dayDate=new Date(viewYear,viewMonth,d); const today=new Date(); today.setHours(0,0,0,0);
        if(dayDate<today) dayDiv.classList.add('dim');
        dayDiv.addEventListener('click', ()=>{ document.getElementById('evt-date').value=iso; document.getElementById('upcoming-form').style.display=''; window.scrollTo({top:0,behavior:'smooth'}); });
        grid.appendChild(dayDiv);
      }
    }

    // Upcoming form and match form wiring (see prior code for full behavior)
    document.getElementById('add-upcoming').addEventListener('click', ()=>{ document.getElementById('upcoming-form').style.display=''; document.getElementById('evt-form').reset(); });

    document.getElementById('save-evt').addEventListener('click', async (e)=>{ e.preventDefault(); const id=document.getElementById('evt-id').value||undefined; const date=document.getElementById('evt-date').value; const title=document.getElementById('evt-title').value.trim()||'Upcoming'; const notes=document.getElementById('evt-notes').value.trim(); const evt={id,date,title,notes,seasonId:currentSeasonId,createdAt:new Date().toISOString()}; try{ await window.dbSaveEvent(evt); document.getElementById('upcoming-form').style.display='none'; }catch(err){ alert('Save failed: '+err.message); } });

    const scoreIds=['jeb-s1','jeb-s2','jeb-s3','gpc-s1','gpc-s2','gpc-s3'];
    scoreIds.forEach(id=>document.getElementById(id).addEventListener('input', updateComputedWinnerDisplay));
    function parseScoreVal(id){ const v=document.getElementById(id).value; return v===''?null:Number(v); }
    function computeSetsAndWinnerFromInputs(){ const jeb=[parseScoreVal('jeb-s1'),parseScoreVal('jeb-s2'),parseScoreVal('jeb-s3')]; const gpc=[parseScoreVal('gpc-s1'),parseScoreVal('gpc-s2'),parseScoreVal('gpc-s3')]; let jebSets=0,gpcSets=0; for(let i=0;i<3;i++){ const a=jeb[i], b=gpc[i]; if(a==null||b==null) continue; if(a>b) jebSets++; else if(b>a) gpcSets++; } const winner = jebSets>=2?TEAMS.JEB.id:(gpcSets>=2?TEAMS.GPC.id:''); return { jeb,gpc,jebSets,gpcSets,winner }; }
    function updateComputedWinnerDisplay(){ const {jebSets,gpcSets,winner}=computeSetsAndWinnerFromInputs(); document.getElementById('jeb-sets-won').textContent=jebSets; document.getElementById('gpc-sets-won').textContent=gpcSets; document.getElementById('winner').value = winner? (winner===TEAMS.JEB.id?`${TEAMS.JEB.label}`:`${TEAMS.GPC.label}`) : ''; }

    document.getElementById('match-form').addEventListener('submit', async (e)=>{ e.preventDefault(); if(!currentSeasonId){ alert('Select or create a season first'); return; } const id=document.getElementById('match-id').value||undefined; const date=document.getElementById('date').value; const jeb=['jeb-s1','jeb-s2','jeb-s3'].map(k=>{ const v=document.getElementById(k).value; return v===''?'' : Number(v); }); const gpc=['gpc-s1','gpc-s2','gpc-s3'].map(k=>{ const v=document.getElementById(k).value; return v===''?'' : Number(v); }); let jebSets=0,gpcSets=0; for(let i=0;i<3;i++){ if(jeb[i]===''||gpc[i]==='') continue; if(Number(jeb[i])>Number(gpc[i])) jebSets++; else if(Number(gpc[i])>Number(jeb[i])) gpcSets++; } const winner = jebSets>=2 ? TEAMS.JEB.id : (gpcSets>=2 ? TEAMS.GPC.id : ''); const matchObj={id,date,jeb,gpc,jebSets,gpcSets,winner,paidBy:document.getElementById('paidBy').value||'',notes:document.getElementById('notes').value.trim(),seasonId:currentSeasonId,createdAt:new Date().toISOString()}; try{ await window.dbSaveMatch(matchObj); const sameDateEvents=(window.events||[]).filter(ev=>ev.date===date); if(sameDateEvents.length>0 && confirm('Remove upcoming events on this date?')) for(const ev of sameDateEvents) await window.dbDeleteEvent(ev.id); clearMatchForm(); }catch(err){ alert('Saving failed: '+err.message);} });

    function clearMatchForm(){ document.getElementById('match-id').value=''; document.getElementById('match-form').reset(); scoreIds.forEach(id=>document.getElementById(id).value=''); document.getElementById('jeb-sets-won').textContent='0'; document.getElementById('gpc-sets-won').textContent='0'; document.getElementById('winner').value=''; }
    document.getElementById('clear-btn').addEventListener('click', clearMatchForm);

    function renderUpcomingList(){ const list=document.getElementById('upcoming-list'); list.innerHTML=''; const ordered=(window.events||[]).slice().sort((a,b)=>(a.date||'').localeCompare(b.date||'')||(a.createdAt||'').localeCompare(b.createdAt||'')); if(ordered.length===0){ list.innerHTML='<div class="small">No upcoming matches or events.</div>'; return; } ordered.forEach(ev=>{ const row=document.createElement('div'); row.className='event-row'; const meta=document.createElement('div'); meta.className='event-meta'; const date=document.createElement('div'); date.style.fontWeight='700'; date.textContent=displayDate(ev.date||''); const title=document.createElement('div'); title.innerHTML=`<div style="font-weight:700">${ev.title||''}</div><div class="small">${ev.notes||''}</div>`; meta.appendChild(date); meta.appendChild(title); const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='6px'; const rec=document.createElement('button'); rec.className='secondary'; rec.textContent='Record result'; rec.onclick=()=>{ document.getElementById('date').value=ev.date; }; const edit=document.createElement('button'); edit.className='secondary'; edit.textContent='Edit'; edit.onclick=()=>{ document.getElementById('evt-id').value=ev.id; document.getElementById('evt-date').value=ev.date; document.getElementById('evt-title').value=ev.title; document.getElementById('evt-notes').value=ev.notes; document.getElementById('upcoming-form').style.display=''; window.scrollTo({top:0,behavior:'smooth'}); }; const del=document.createElement('button'); del.className='danger'; del.textContent='Delete'; del.onclick=async ()=>{ if(confirm('Delete upcoming?')) await window.dbDeleteEvent(ev.id); }; actions.appendChild(rec); actions.appendChild(edit); actions.appendChild(del); row.appendChild(meta); row.appendChild(actions); list.appendChild(row); }); }

    function renderMatchesTable(){ const tbody=document.querySelector('#matches-table tbody'); tbody.innerHTML=''; const matches=(window.matches||[]).slice().sort((a,b)=> (b.date||'').localeCompare(a.date||'') || (b.createdAt||'').localeCompare(a.createdAt||'')); if(matches.length===0){ const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=6; td.className='small'; td.textContent='No matches yet.'; tr.appendChild(td); tbody.appendChild(tr); return; } matches.forEach(m=>{ const tr=document.createElement('tr'); const dateCell=document.createElement('td'); const d=document.createElement('div'); d.textContent=displayDate(m.date||''); const s=document.createElement('div'); s.className='small'; s.textContent=(window.seasons||[]).find(x=>x.id===m.seasonId)?.name||'(no season)'; dateCell.appendChild(d); dateCell.appendChild(s); tr.appendChild(dateCell); const scoreCell=document.createElement('td'); scoreCell.innerHTML=`<table class="score-table" style="margin:0"><tbody><tr><td style="text-align:left"><strong>${TEAMS.JEB.label}${m.winner===TEAMS.JEB.id?'*':''}</strong></td><td>${m.jeb?.[0]??''}</td><td>${m.jeb?.[1]??''}</td><td>${m.jeb?.[2]??''}</td><td><span class="sets-won-badge">${m.jebSets??0}</span></td></tr><tr><td style="text-align:left"><strong>${TEAMS.GPC.label}${m.winner===TEAMS.GPC.id?'*':''}</strong></td><td>${m.gpc?.[0]??''}</td><td>${m.gpc?.[1]??''}</td><td>${m.gpc?.[2]??''}</td><td><span class="sets-won-badge">${m.gpcSets??0}</span></td></tr></tbody></table>`; tr.appendChild(scoreCell); const winnerCell=document.createElement('td'); winnerCell.innerHTML=m.winner?`<span class="winner-badge">${m.winner===TEAMS.JEB.id?TEAMS.JEB.label:TEAMS.GPC.label}</span>`:''; tr.appendChild(winnerCell); const paidCell=document.createElement('td'); paidCell.textContent=m.paidBy||''; tr.appendChild(paidCell); const notesCell=document.createElement('td'); notesCell.textContent=m.notes||''; tr.appendChild(notesCell); const actionsCell=document.createElement('td'); const editBtn=document.createElement('button'); editBtn.className='secondary'; editBtn.textContent='Edit'; editBtn.onclick=()=>{ document.getElementById('match-id').value=m.id; document.getElementById('date').value=m.date; ['jeb-s1','jeb-s2','jeb-s3'].forEach((k,i)=>document.getElementById(k).value=m.jeb?.[i]??''); ['gpc-s1','gpc-s2','gpc-s3'].forEach((k,i)=>document.getElementById(k).value=m.gpc?.[i]??''); document.getElementById('paidBy').value=m.paidBy||''; document.getElementById('notes').value=m.notes||''; updateComputedWinnerDisplay(); window.scrollTo({top:0,behavior:'smooth'}); }; const delBtn=document.createElement('button'); delBtn.className='danger'; delBtn.textContent='Delete'; delBtn.onclick=async ()=>{ if(confirm('Delete this match?')) await window.dbDeleteMatch(m.id); }; actionsCell.appendChild(editBtn); actionsCell.appendChild(delBtn); tr.appendChild(actionsCell); tbody.appendChild(tr); }); }

    function renderRecords(){ document.getElementById('stored-count').textContent=`${(window.matches||[]).length} total matches`; const seasonMatches=(window.matches||[]).filter(m=>m.seasonId===currentSeasonId && m.winner); let sJ=0,sG=0; seasonMatches.forEach(m=>{ if(m.winner===TEAMS.JEB.id) sJ++; if(m.winner===TEAMS.GPC.id) sG++; }); const all=(window.matches||[]).filter(m=>m.winner); let aJ=0,aG=0; all.forEach(m=>{ if(m.winner===TEAMS.JEB.id) aJ++; if(m.winner===TEAMS.GPC.id) aG++; }); document.getElementById('season-record').textContent=`${TEAMS.JEB.label} ${sJ}-${sG} • ${TEAMS.GPC.label} ${sG}-${sJ}`; document.getElementById('alltime-record').textContent=`${TEAMS.JEB.label} ${aJ}-${aG} • ${TEAMS.GPC.label} ${aG}-${aJ}`; }

    function renderAll(){ populateSeasonsUI(); renderCalendar(); renderUpcomingList(); renderMatchesTable(); renderRecords(); }

    (async function init(){ const last=localStorage.getItem('padel.lastSeasonId'); if(last) currentSeasonId=last; try{ await window.dbFetchNow(); }catch(e){ console.warn(e); } populateSeasonsUI(); renderAll(); })();
  </script>
</body>
</html>